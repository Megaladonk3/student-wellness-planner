<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Wellness Planner</title>
    <style>
        /* CSS Custom Properties for Theming */
        :root {
            --bg-color: #c6e2ff;
            --header-bg: #a0c4e8;
            --widget-bg: #ffffff;
            --widget-border-color: #d8c8ff;
            --text-color: #333333;
            --text-light: #555555;
            --accent-color: #8a63d2;
            --nav-link-color: #000000;
            --nav-link-hover-bg: #b0d0f0;
            --progress-bar-bg: #e0e0e0;
            --progress-bar-fill-1: #b298dc;
            --progress-bar-fill-2: #8a63d2;
            --progress-bar-fill-complete: #4CAF50;
            --icon-color: #333333;
            --button-bg: #e6e6fa;
            --button-text: #333;
            --box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            --accent-color-translucent: rgba(138, 99, 210, 0.2);
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --sidebar-button-bg: var(--widget-bg);
            --sidebar-button-text: var(--text-color);
            --sidebar-button-hover-bg: var(--bg-color);
            --modal-header-bg: var(--header-bg);
            --input-bg: var(--bg-color);
            --danger-color: #f44336;
            --danger-color-hover: #d32f2f;
            --warning-color: #ffc107;

            /* Custom properties for the prominent TODO button */
            --new-todo-btn-bg: var(--accent-color);
            --new-todo-btn-text: #ffffff;
            --new-todo-btn-shadow: 0 4px 10px rgba(138, 99, 210, 0.35);
            --new-todo-btn-hover-shadow: 0 6px 14px rgba(138, 99, 210, 0.45);
        }

        body.dark-mode {
            --bg-color: #232931;
            --header-bg: #1a1f25;
            --widget-bg: #393e46;
            --widget-border-color: #5c5178;
            --text-color: #eeeeee;
            --text-light: #cccccc;
            --accent-color: #b298dc;
            --nav-link-color: #eeeeee;
            --nav-link-hover-bg: #4a5058;
            --progress-bar-bg: #555555;
            --progress-bar-fill-1: #9370DB;
            --progress-bar-fill-2: #8a63d2;
            --progress-bar-fill-complete: #67BD67;
            --icon-color: #eeeeee;
            --button-bg: #504660;
            --button-text: #eeeeee;
            --box-shadow: 0 2px 5px rgba(255,255,255,0.05);
            --accent-color-translucent: rgba(178, 152, 220, 0.3);
            --modal-overlay-bg: rgba(0, 0, 0, 0.7);
            --sidebar-button-bg: var(--widget-bg);
            --sidebar-button-text: var(--text-color);
            --sidebar-button-hover-bg: var(--header-bg);
            --modal-header-bg: var(--header-bg);
            --input-bg: var(--header-bg);
            --danger-color: #ef5350;
            --danger-color-hover: #e53935;
            --warning-color: #ffca28;

            /* Custom properties for the prominent TODO button in dark mode */
            --new-todo-btn-bg: var(--accent-color);
            --new-todo-btn-text: #ffffff;
            --new-todo-btn-shadow: 0 4px 10px rgba(178, 152, 220, 0.35);
            --new-todo-btn-hover-shadow: 0 6px 14px rgba(178, 152, 220, 0.45);
        }

        /* Basic Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            padding-top: 60px; padding-left: 220px;
        }

        /* Header */
        header {
            background-color: var(--header-bg); color: var(--nav-link-color); padding: 0 20px;
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; box-shadow: var(--box-shadow);
        }

        .logo {
            width: 45px;
            height: 45px;
            position: relative;
        }
        .logo img {
            width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid var(--widget-border-color); object-fit: cover;
            cursor: pointer; background-color: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .logo img:hover {
            transform: scale(1.08);
            box-shadow: 0 0 10px var(--accent-color-translucent);
        }
        .logo input[type="file"] { display: none; }

        .delete-avatar-btn {
            position: absolute; top: -5px; right: -5px; width: 24px; height: 24px;
            background-color: var(--danger-color); color: white; border: 2px solid var(--widget-bg);
            border-radius: 50%; cursor: pointer; font-size: 1.1em; line-height: 20px;
            text-align: center; opacity: 0; transform: scale(0.8);
            transition: opacity 0.2s, transform 0.2s; z-index: 10;
        }
        .logo:hover .delete-avatar-btn { opacity: 1; transform: scale(1); }
        .delete-avatar-btn:hover { background-color: var(--danger-color-hover); transform: scale(1.1); }

        header nav { margin-left: 25px; flex-grow: 1; }
        header nav a {
            color: var(--nav-link-color); text-decoration: none; margin: 0 15px;
            font-weight: bold; padding: 5px 0; border-bottom: 2px solid transparent;
            transition: border-bottom 0.3s;
        }
        header nav a:hover { border-bottom: 2px solid var(--accent-color); }
        .search-bar { display: flex; align-items: center; }
        .search-bar input[type="search"] {
            padding: 8px 12px; border: 1px solid var(--widget-border-color); border-right: none;
            border-radius: 20px 0 0 20px; background-color: var(--widget-bg);
            color: var(--text-color); min-width: 200px;
        }
        .search-bar input[type="search"]::placeholder { color: var(--text-light); }
        .search-bar button {
            padding: 8px 12px; background-color: var(--widget-bg);
            border: 1px solid var(--widget-border-color); border-left: none;
            border-radius: 0 20px 20px 0; cursor: pointer; color: var(--icon-color);
        }

        /* Left Sidebar */
        .left-sidebar {
            position: fixed; top: 60px; left: 0; width: 220px; height: calc(100vh - 60px);
            background-color: var(--bg-color); padding: 20px; display: flex;
            flex-direction: column; gap: 15px;
            border-right: 1px solid var(--widget-border-color); z-index: 999; overflow-y: auto;
        }

        #newPageBtn {
            padding: 15px 12px; background-color: var(--new-todo-btn-bg);
            color: var(--new-todo-btn-text); border: none; border-radius: 10px;
            cursor: pointer; font-weight: 600; font-size: 1.1em; text-align: center;
            width: 100%; box-shadow: var(--new-todo-btn-shadow);
            transition: background-color 0.2s, color 0.2s, filter 0.2s, transform 0.2s, box-shadow 0.2s;
        }

        #newPageBtn:hover, #newPageBtn:focus {
            filter: brightness(1.12); transform: translateY(-2px) scale(1.02);
            box-shadow: var(--new-todo-btn-hover-shadow); outline: none;
        }

        .sidebar-tab-button {
            padding: 12px; background-color: var(--sidebar-button-bg);
            color: var(--sidebar-button-text); border: 1px solid var(--widget-border-color);
            border-radius: 8px; cursor: pointer; font-weight: bold; text-align: left;
            transition: background-color 0.3s, filter 0.2s; width: 100%;
            box-shadow: var(--box-shadow); display: flex; align-items: center;
        }
        .sidebar-tab-button:hover { background-color: var(--sidebar-button-hover-bg); filter: brightness(0.98); }
        .sidebar-tab-button .tab-icon { margin-right: 10px; font-size: 1.1em; color: var(--accent-color); }

        /* Main Content Area */
        .main-content { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .motivational-quote-banner {
            background-color: var(--widget-bg); border: 1px solid var(--widget-border-color);
            padding: 15px; text-align: center; font-style: italic; border-radius: 8px;
            box-shadow: var(--box-shadow); color: var(--text-light);
        }
        .widgets-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
        }
        .widget {
            background-color: var(--widget-bg); border: 1px solid var(--widget-border-color);
            border-radius: 12px; padding: 20px; box-shadow: var(--box-shadow);
            color: var(--text-color); display: flex; flex-direction: column;
            transition: background-color 0.3s ease-out;
        }
        .widget h2 { margin-bottom: 15px; font-size: 1.5em; color: var(--text-color); }
        .widget .widget-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .widget .widget-header h2 { margin-bottom: 0; flex-grow: 1; margin-right: 10px; }
        .widget .close-btn {
            background: none; border: none; font-size: 1.8em; cursor: pointer;
            color: var(--icon-color); padding: 0 5px; line-height: 1;
        }

        .reminders-widget ul#remindersList {
            list-style: none; margin-bottom: 15px; padding: 0;
            max-height: 250px; overflow-y: auto;
        }
        .reminders-widget li {
            padding: 10px 5px; border-bottom: 1px solid var(--widget-border-color);
            display: flex; align-items: center; gap: 10px; transition: background-color 0.2s;
        }
        .reminders-widget li:hover { background-color: rgba(0,0,0,0.03); }
        body.dark-mode .reminders-widget li:hover { background-color: rgba(255,255,255,0.05); }
        .reminders-widget li:last-child { border-bottom: none; }
        .reminders-widget .reminder-checkbox {
            accent-color: var(--accent-color); width: 18px; height: 18px; flex-shrink: 0;
        }
        .reminders-widget .reminder-details { flex-grow: 1; }
        .reminders-widget .reminder-text { color: var(--text-light); cursor: pointer; padding: 3px 5px; border-radius: 3px; }
        .reminders-widget .reminder-date {
            font-size: 0.8em; color: var(--accent-color); font-weight: bold; margin-top: 4px;
        }
        .reminders-widget .reminder-text[contenteditable="true"] {
            cursor: text; outline: 1px solid var(--accent-color);
            background-color: var(--input-bg); box-shadow: 0 0 0 2px var(--accent-color-translucent);
        }
        .reminders-widget .reminder-text.completed { text-decoration: line-through; color: var(--text-light); opacity: 0.7; }
        .reminders-widget .delete-reminder-btn {
            background: none; border: none; color: var(--danger-color);
            font-size: 1.3em; font-weight: bold; cursor: pointer; padding: 0 5px;
            line-height: 1; border-radius: 50%; transition: color 0.2s, background-color 0.2s;
            flex-shrink: 0;
        }
        .reminders-widget .delete-reminder-btn:hover { color: white; background-color: var(--danger-color-hover); }
        .add-reminder-form {
            display: flex; gap: 10px; margin-top: 10px;
            border-top: 1px solid var(--widget-border-color); padding-top: 15px;
        }
        .add-reminder-form #newReminderInput {
            flex-grow: 1; padding: 8px 10px; border: 1px solid var(--widget-border-color);
            border-radius: 6px; background-color: var(--input-bg);
            color: var(--text-color); font-size: 0.95em;
        }
         .add-reminder-form #newReminderInput::placeholder { color: var(--text-light); opacity: 0.8; }
        .add-reminder-form #addReminderBtn {
            padding: 8px 15px; background-color: var(--accent-color); color: white;
            border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
            transition: filter 0.2s;
        }
        .add-reminder-form #addReminderBtn:hover { filter: brightness(0.9); }

        .todo-card ul.task-list { list-style: none; margin-bottom: 20px; padding-left: 5px; }
        .todo-card ul.task-list li {
            padding: 8px 0; display: flex; flex-wrap: wrap; align-items: center;
            gap: 5px 10px; border-bottom: 1px solid var(--widget-border-color);
        }
        .todo-card ul.task-list li:last-child { border-bottom: none; }
        .todo-card input[type="checkbox"] {
            margin-right: 5px; accent-color: var(--accent-color);
            width: 18px; height: 18px; flex-shrink: 0;
        }
        .todo-card .task-content {
            display: flex; flex-direction: column; flex-grow: 1; min-width: 0;
        }
        .todo-card .task-label { color: var(--text-light); word-break: break-word; cursor: pointer; }
        .todo-card .task-label.overdue { color: var(--danger-color); font-weight: bold; }
        .todo-card .task-due-date-input {
            margin-top: 2px; padding: 2px 4px; border: 1px solid var(--widget-border-color);
            border-radius: 4px; font-size: 0.8em; color: var(--text-light);
            background-color: var(--input-bg); cursor: pointer; width: fit-content;
        }
        body.dark-mode .todo-card .task-due-date-input { background-color: var(--header-bg); }
        .todo-card .delete-task-btn {
            background: none; border: none; color: var(--danger-color);
            font-size: 1.2em; font-weight: bold; cursor: pointer; padding: 0 5px;
            line-height: 1; border-radius: 50%; transition: color 0.2s, background-color 0.2s;
            flex-shrink: 0; margin-left: auto;
        }
        .todo-card .delete-task-btn:hover { color: white; background-color: var(--danger-color-hover); }
        .progress-item { margin-bottom: 15px; margin-top: auto; }
        .progress-bar-container {
            width: 100%; background-color: var(--progress-bar-bg); border-radius: 10px;
            height: 20px; overflow: hidden; margin-bottom: 5px;
            border: 1px solid var(--widget-border-color);
        }
        .progress-bar {
            height: 100%; background-color: var(--progress-bar-fill-1);
            border-radius: 10px 0 0 10px; transition: width 0.5s ease-in-out, background-color 0.5s ease;
            text-align: center; color: white; font-size: 0.8em; line-height: 20px;
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .progress-bar.full { border-radius: 10px; }
        .progress-label { font-size: 0.9em; color: var(--text-light); text-align: center; }
        .todo-card .card-title-text[contenteditable="true"], .todo-card .task-label[contenteditable="true"] {
            cursor: text; padding: 2px 4px; border-radius: 3px; min-width: 20px;
            display: inline-block; background-color: transparent;
        }
        .todo-card .card-title-text[contenteditable="true"]:hover, .todo-card .task-label[contenteditable="true"]:hover { background-color: rgba(0,0,0,0.05); }
        body.dark-mode .todo-card .card-title-text[contenteditable="true"]:hover, body.dark-mode .todo-card .task-label[contenteditable="true"]:hover { background-color: rgba(255,255,255,0.1); }
        .todo-card .card-title-text[contenteditable="true"]:focus, .todo-card .task-label[contenteditable="true"]:focus {
            outline: 1px solid var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color-translucent);
            background-color: var(--widget-bg);
        }
        .add-task-btn {
            background-color: var(--button-bg); color: var(--button-text);
            border: 1px solid var(--widget-border-color); padding: 6px 10px;
            border-radius: 5px; cursor: pointer; margin-top: 12px; margin-bottom: 10px;
            display: block; width: fit-content; margin-left: auto; margin-right: auto;
            transition: background-color 0.2s, filter 0.2s;
        }
        .add-task-btn:hover { filter: brightness(0.95); }

        /* Differentiated Horoscope Section */
        .horoscope-section {
            text-align: center; margin-top: 20px; padding: 25px;
            background-color: var(--widget-bg); border: 1px solid var(--widget-border-color);
            border-radius: 12px; box-shadow: var(--box-shadow);
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .horoscope-header {
            display: flex; align-items: center; gap: 12px; color: var(--accent-color);
        }
        .horoscope-icon { font-size: 2.8em; line-height: 1; }
        .horoscope-header h3 { font-size: 1.6em; margin: 0; color: var(--text-color); }
        #getHoroscopeBtn {
            padding: 10px 22px; background-color: var(--accent-color); color: white;
            border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 1em;
            transition: filter 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(138, 99, 210, 0.2);
        }
        #getHoroscopeBtn:hover {
            filter: brightness(1.1); transform: scale(1.03); box-shadow: 0 4px 8px rgba(138, 99, 210, 0.3);
        }

        /* Fixed Bottom Left Controls */
        .fixed-bottom-left {
            position: fixed; bottom: 20px; left: 20px;
            display: flex; flex-direction: column; gap: 15px; z-index: 1000;
        }
        .left-sidebar .mood-tracker-launcher {
            width: 100%; box-sizing: border-box; display: flex; flex-wrap: wrap;
            justify-content: center; gap: 8px; padding: 12px 8px;
            background-color: var(--sidebar-button-bg); border: 1px solid var(--widget-border-color);
            border-radius: 8px; box-shadow: var(--box-shadow);
        }
        .mood-emoji-trigger { font-size: 2em; cursor: pointer; transition: transform 0.2s; opacity: 0.7; }
        .mood-emoji-trigger:hover { transform: scale(1.2); opacity: 1; }
        .theme-toggle {
            display: flex; align-items: center; cursor: pointer; font-size: 0.9em;
            color: var(--text-light); background-color: var(--widget-bg);
            border: 1px solid var(--widget-border-color); padding: 8px 12px;
            border-radius: 20px; box-shadow: var(--box-shadow);
        }
        #themeIcon { font-size: 1.5em; margin-right: 8px; color: var(--icon-color); }

        .calendar-widget {
             --cal-day-hover-bg: var(--accent-color-translucent); --cal-today-border: 2px solid var(--accent-color);
             --cal-event-dot-incomplete: var(--danger-color); --cal-event-dot-partial: var(--warning-color);
             --cal-event-dot-complete: var(--progress-bar-fill-complete);
       }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-header h3 { margin: 0; font-size: 1.1em; font-weight: 600; }
        .calendar-nav-btn {
            background: none; border: none; font-size: 1.6em; color: var(--icon-color);
            cursor: pointer; padding: 0 8px; border-radius: 50%;
            transition: background-color 0.2s, transform 0.2s;
        }
        .calendar-nav-btn:hover { background-color: var(--bg-color); transform: scale(1.1); }
        .calendar-grid-widget { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .cal-day-name, .cal-day {
            text-align: center; padding: 5px; font-size: 0.85em; font-weight: 600;
            color: var(--text-light); aspect-ratio: 1 / 1; display: flex;
            justify-content: center; align-items: center;
        }
        .cal-day {
            cursor: default; border-radius: 50%; position: relative;
            transition: background-color 0.2s, color 0.2s; color: var(--text-color);
        }
        .cal-day:hover { background-color: var(--cal-day-hover-bg); }
        .cal-day.not-current-month { color: var(--text-light); opacity: 0.4; pointer-events: none; }
        .cal-day.today { box-shadow: 0 0 0 var(--cal-today-border); font-weight: bold; }
        .cal-day .event-dot {
            position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%);
            width: 6px; height: 6px; border-radius: 50%; transition: background-color 0.3s;
        }
        .cal-day .event-dot.dot-red { background-color: var(--cal-event-dot-incomplete); }
        .cal-day .event-dot.dot-yellow { background-color: var(--cal-event-dot-partial); }
        .cal-day .event-dot.dot-green { background-color: var(--cal-event-dot-complete); }

        /* Modal Overlays (Common) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-overlay-bg); display: none;
            align-items: center; justify-content: center; z-index: 1500;
            animation: fadeIn 0.4s ease-out forwards;
        }
        .modal-overlay.fade-out { animation: fadeOut 0.4s ease-in forwards; }

        .modal-content {
            background-color: var(--widget-bg); border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%;
            transform: scale(0.8) translateY(20px); opacity: 0;
            animation: popIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
        }
        .modal-overlay.fade-out .modal-content { animation: popOut 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }

        /* Task Hover Tooltip */
        .calendar-task-tooltip {
            position: absolute; background-color: var(--widget-bg); border: 1px solid var(--accent-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 12px; border-radius: 8px;
            z-index: 2000; pointer-events: none; max-width: 250px; font-size: 0.9em;
            opacity: 0; transform: scale(0.95) translateY(5px); transition: opacity 0.2s ease, transform 0.2s ease;
            white-space: normal;
        }
        .calendar-task-tooltip.visible { opacity: 1; transform: scale(1) translateY(0); }
        .calendar-task-tooltip h4 {
            margin-top: 0; margin-bottom: 8px; font-size: 0.95em;
            color: var(--accent-color); border-bottom: 1px solid var(--widget-border-color); padding-bottom: 5px;
        }
        .calendar-task-tooltip ul { list-style: none; padding: 0; margin: 0; }
        .calendar-task-tooltip li { padding: 4px 0; color: var(--text-light); word-break: break-word; }
        .calendar-task-tooltip li:not(:last-child) { border-bottom: 1px dashed var(--widget-border-color); }
        .calendar-task-tooltip li.completed-task { text-decoration: line-through; opacity: 0.7; }

        /* Mood Logging Modal */
        #moodLoggingModal .modal-content { max-width: 450px; text-align: center; padding: 25px; }
        #moodLoggingModal h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.4em; color: var(--text-color); }
        #modalSelectedMoodEmoji { font-size: 3em; margin-bottom: 15px; }
        #moodNoteInput {
            width: 100%; min-height: 80px; padding: 10px;
            border: 1px solid var(--widget-border-color); border-radius: 6px; margin-bottom: 20px;
            font-family: inherit; font-size: 1em; background-color: var(--input-bg); color: var(--text-color);
        }
        .modal-actions {
            padding: 10px 20px 20px; display: flex; justify-content: flex-end; gap: 10px;
        }
        .modal-actions button {
            padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer;
            font-weight: bold; margin: 0 5px; transition: filter 0.2s;
        }
        .modal-actions .save-mood-btn { background-color: var(--accent-color); color: white; }
        .modal-actions .cancel-mood-btn { background-color: var(--progress-bar-bg); color: var(--text-color); }
        .modal-actions button:hover { filter: brightness(0.9); }

        /* Full Mood Log View Modal */
        #fullMoodLogViewModal .modal-content { max-width: 700px; height: 80vh; display: flex; flex-direction: column; padding: 0; }
        #fullMoodLogViewModal .modal-header {
            padding: 15px 20px; background-color: var(--modal-header-bg); color: var(--nav-link-color);
            border-bottom: 1px solid var(--widget-border-color); border-radius: 12px 12px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        #fullMoodLogViewModal .modal-header h3 { margin: 0; font-size: 1.6em; }
        #fullMoodLogViewModal .close-full-log-btn {
            background: none; border: none; font-size: 2em; color: var(--nav-link-color);
            cursor: pointer; line-height: 1; padding: 0 5px;
        }
        #fullMoodLogViewModal .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        #fullMoodLogViewModal #fullLogListContainer { list-style: none; padding: 0; }
        #fullMoodLogViewModal #fullLogListContainer li {
            padding: 12px 0; border-bottom: 1px solid var(--widget-border-color);
            display: flex; gap: 15px; align-items: flex-start;
        }
        #fullMoodLogViewModal #fullLogListContainer li:last-child { border-bottom: none; }
        #fullMoodLogViewModal #fullLogListContainer .log-emoji { font-size: 2em; margin-top: 2px; flex-shrink: 0; }
        #fullMoodLogViewModal #fullLogListContainer .log-details { flex-grow: 1; }
        #fullMoodLogViewModal #fullLogListContainer .log-note {
            font-size: 1em; color: var(--text-color); margin-bottom: 5px; white-space: pre-wrap; word-break: break-word;
        }
        #fullMoodLogViewModal #fullLogListContainer .log-timestamp { font-size: 0.8em; color: var(--text-light); }
        #fullMoodLogViewModal .empty-full-log-message { text-align: center; padding: 30px; font-size: 1.1em; color: var(--text-light); }

        /* Reminder Pop-up Calendar */
        #reminderCalendarModal .modal-content { max-width: 400px; border: 1px solid var(--widget-border-color); }
        #reminderCalendarModal .modal-header {
            padding: 15px 20px; background-color: var(--modal-header-bg); border-bottom: 1px solid var(--widget-border-color);
            border-radius: 12px 12px 0 0;
        }
        #reminderCalendarModal #calendarMonthYear { font-weight: bold; font-size: 1.1em; }
        #reminderCalendarModal #prevMonthBtn, #reminderCalendarModal #nextMonthBtn {
            background: none; border: none; font-size: 1.8em; color: var(--text-color);
            cursor: pointer; padding: 0 10px; transition: transform 0.2s;
        }
        #reminderCalendarModal #prevMonthBtn:hover, #reminderCalendarModal #nextMonthBtn:hover { transform: scale(1.2); }
        #reminderCalendarModal #calendarGrid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; padding: 20px; }
        #reminderCalendarModal .calendar-day-name, #reminderCalendarModal .calendar-day { text-align: center; padding: 8px; font-weight: bold; color: var(--text-light); }
        #reminderCalendarModal .calendar-day {
            cursor: pointer; border-radius: 50%; position: relative;
            transition: background-color 0.2s, color 0.2s, transform 0.2s; color: var(--text-color);
        }
        #reminderCalendarModal .calendar-day:hover { background-color: var(--accent-color-translucent); transform: scale(1.1); }
        #reminderCalendarModal .calendar-day.not-current-month { color: var(--text-light); opacity: 0.5; pointer-events: none; }
        #reminderCalendarModal .calendar-day.today { box-shadow: 0 0 0 2px solid var(--accent-color); }
        #reminderCalendarModal .calendar-day.selected { background-color: var(--accent-color); color: var(--new-todo-btn-text) !important; font-weight: bold; }
        #reminderCalendarModal #reminderTimeSection { padding: 0 20px 20px; text-align: center; }
        #reminderCalendarModal #reminderTimeSection label { font-weight: bold; margin-right: 10px; }
        #reminderCalendarModal #reminderTimeInput {
            padding: 8px; border-radius: 6px; border: 1px solid var(--widget-border-color);
            background-color: var(--input-bg); color: var(--text-color); font-family: inherit;
        }

        /* ===== NEW: Horoscope Modal Styles ===== */
        #horoscopeModal .modal-content {
            max-width: 550px;
            padding: 40px;
            text-align: center;
            color: #fff;
            position: relative;
            overflow: hidden; /* Important for gradient effect */
            background: linear-gradient(270deg, #4d2f8c, #2c3e50, #8a63d2, #463d60);
            background-size: 400% 400%;
            /* === FIX STARTS HERE === */
            animation: popIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards, gradient-flow 15s ease infinite;
            /* === FIX ENDS HERE === */
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        #horoscopeModal .close-horoscope-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2.5em;
            color: rgba(255, 255, 255, 0.8);
            background: none;
            border: none;
            cursor: pointer;
            line-height: 1;
            transition: transform 0.2s, color 0.2s;
        }
        #horoscopeModal .close-horoscope-btn:hover {
            color: #fff;
            transform: scale(1.2);
        }
        #horoscopeEmoji {
            font-size: 5em; /* Large emoji */
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        #horoscopeModalText {
            font-size: 1.4em;
            font-style: italic;
            font-weight: 300;
            line-height: 1.6;
            min-height: 120px; /* Space for text to type out */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes popIn { from { transform: scale(0.8) translateY(20px); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes popOut { from { transform: scale(1); opacity: 1; } to { transform: scale(0.8) translateY(20px); opacity: 0; } }
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Confetti */
        #confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 2000; }
        .confetti-piece { position: absolute; width: 8px; height: 16px; opacity: 0; animation: fall 3s ease-out forwards; }
        @keyframes fall { 0% { opacity: 1; transform: translateY(-10vh) rotateZ(0deg); } 100% { opacity: 0; transform: translateY(110vh) rotateZ(720deg); } }

        /* Responsive Adjustments */
        @media (max-width: 992px) { body { padding-left: 0; } .left-sidebar { display: none; } .widgets-container { grid-template-columns: 1fr; } .fixed-bottom-left { left: 10px; bottom: 10px; } }
        @media (max-width: 1200px) { .widgets-container { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); } }
        @media (max-width: 768px) {
            header { padding: 0 10px; height: auto; flex-direction: column; align-items: flex-start; padding-bottom: 10px; }
            body { padding-top: 120px; }
            header nav { margin-top:10px; width: 100%; display: flex; justify-content: space-around; }
            header nav a { margin: 0 5px; }
            .search-bar { margin-top: 10px; width: 100%; }
            .search-bar input[type="search"] { flex-grow: 1; }
            .fixed-bottom-left{ flex-direction: row; align-items: center; width: calc(100% - 20px); justify-content: space-around; background-color: var(--header-bg); padding: 5px; border-radius: 8px; }
            /* Mood tracker was removed from fixed bottom left, no need for styles here */
            .theme-toggle { padding: 5px 8px; }
            #fullMoodLogViewModal .modal-content { height: 90vh; width: 95%; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <label for="avatarInput" title="Click to change profile picture">
                <img id="avatarImage" src="https://cdn.vectorstock.com/i/1000v/66/13/default-avatar-profile-icon-social-media-user-vector-49816613.jpg" alt="User Avatar">
            </label>
            <button id="deleteAvatarBtn" class="delete-avatar-btn" title="Delete profile picture">√ó</button>
            <input type="file" id="avatarInput" accept="image/png, image/jpeg, image/gif">
        </div>
        <nav>
            <a href="index.html" id="navHome">Home</a>
            <a href="about.html" id="navAbout">About Us</a>
            <a href="resources.html" id="navResources">Resources</a>
        </nav>
        <div class="search-bar">
            <input type="search" id="searchInput" placeholder="Search...">
            <button id="searchButton">Ôîç</button>
        </div>
    </header>

    <aside class="left-sidebar">
        <button class="new-page-btn" id="newPageBtn">+ New TODO List</button>
        <button class="sidebar-tab-button" id="viewMoodLogTabBtn">
            <span class="tab-icon">üìú</span> View Full Mood Log
        </button>
        <div class="mood-tracker-launcher">
            <span class="mood-emoji-trigger" data-mood="happy" data-emoji="üòä" title="Log Happy Mood">üòä</span>
            <span class="mood-emoji-trigger" data-mood="sad" data-emoji="üòü" title="Log Sad Mood">üòü</span>
            <span class="mood-emoji-trigger" data-mood="neutral" data-emoji="üòê" title="Log Neutral Mood">üòê</span>
            <span class="mood-emoji-trigger" data-mood="excited" data-emoji="ü•≥" title="Log Excited Mood">ü•≥</span>
            <span class="mood-emoji-trigger" data-mood="stressed" data-emoji="üò´" title="Log Stressed Mood">üò´</span>
        </div>
    </aside>

    <main class="main-content">
        <section class="motivational-quote-banner">
            <p id="motivationalQuoteP">"Loading motivational quote..."</p>
        </section>

        <div class="widgets-container">
            <section class="widget reminders-widget" id="remindersWidget">
                <h2>Reminders</h2>
                <ul id="remindersList"></ul>
                <div class="add-reminder-form">
                    <input type="text" id="newReminderInput" placeholder="Type reminder, then click '+' to set date...">
                    <button id="addReminderBtn" title="Set Date & Time for Reminder">+</button>
                </div>
            </section>

            <section class="widget calendar-widget" id="calendarWidget">
                <h2>Calendar</h2>
                <div class="calendar-header">
                    <button id="calPrevMonthBtn" class="calendar-nav-btn" title="Previous Month"><</button>
                    <h3 id="calMonthYear">Month Year</h3>
                    <button id="calNextMonthBtn" class="calendar-nav-btn" title="Next Month">></button>
                </div>
                <div id="widgetCalendarGrid" class="calendar-grid-widget"></div>
            </section>
        </div>

        <section class="horoscope-section">
            <div class="horoscope-header">
                <span class="horoscope-icon">üîÆ</span>
                <h3>Your Daily Insight</h3>
            </div>
            <button id="getHoroscopeBtn">Reveal Today's Horoscope</button>
        </section>
    </main>

    <div class="fixed-bottom-left">
        <div class="theme-toggle" id="themeToggleBtn">
            <span id="themeIcon">‚òÄÔ∏è</span>
            <span id="themeToggleText">Light/Dark mode Toggle</span>
        </div>
    </div>

    <!-- Modals -->
    <div id="moodLoggingModal" class="modal-overlay">
        <div class="modal-content">
            <h3>How are you feeling?</h3>
            <div id="modalSelectedMoodEmoji"></div>
            <textarea id="moodNoteInput" placeholder="Add a note (optional)..."></textarea>
            <div class="modal-actions">
                <button id="cancelMoodLogBtn" class="cancel-mood-btn">Cancel</button>
                <button id="saveMoodLogBtn" class="save-mood-btn">Log Mood</button>
            </div>
        </div>
    </div>

    <div id="fullMoodLogViewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Full Mood Log</h3>
                <button id="closeFullLogViewBtn" class="close-full-log-btn" title="Close Log View">√ó</button>
            </div>
            <div class="modal-body">
                <ul id="fullLogListContainer">
                </ul>
            </div>
        </div>
    </div>

    <div id="reminderCalendarModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <button id="prevMonthBtn" title="Previous Month"><</button>
                <h3 id="calendarMonthYear">Month Year</h3>
                <button id="nextMonthBtn" title="Next Month">></button>
            </div>
            <div id="calendarGrid">
            </div>
            <div id="reminderTimeSection">
                <label for="reminderTimeInput">Set Time:</label>
                <input type="time" id="reminderTimeInput">
            </div>
            <div class="modal-actions">
                <button id="cancelReminderBtn" class="cancel-mood-btn">Cancel</button>
                <button id="setReminderBtn" class="save-mood-btn">Set Reminder</button>
            </div>
        </div>
    </div>

    <div id="horoscopeModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeHoroscopeBtn" class="close-horoscope-btn" title="Close">√ó</button>
            <div id="horoscopeEmoji"></div>
            <p id="horoscopeModalText"></p>
        </div>
    </div>

    <div id="confetti-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let todoCardsData = [];
            let reminders = [];
            let typingIntervalId = null;

            // ===== AVATAR PICTURE FUNCTIONALITY =====
            const avatarImage = document.getElementById('avatarImage');
            const avatarInput = document.getElementById('avatarInput');
            const deleteAvatarBtn = document.getElementById('deleteAvatarBtn');
            const defaultAvatarUrl = 'https://cdn.vectorstock.com/i/1000v/66/13/default-avatar-profile-icon-social-media-user-vector-49816613.jpg';

            function loadAvatar() {
                const savedAvatar = localStorage.getItem('userAvatar');
                avatarImage.src = savedAvatar || defaultAvatarUrl;
            }
            loadAvatar();

            avatarInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageDataUrl = e.target.result;
                        avatarImage.src = imageDataUrl;
                        localStorage.setItem('userAvatar', imageDataUrl);
                    };
                    reader.readAsDataURL(file);
                }
            });

            deleteAvatarBtn.addEventListener('click', () => {
                localStorage.removeItem('userAvatar');
                avatarImage.src = defaultAvatarUrl;
            });

            // --- THEME TOGGLE ---
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const themeIcon = document.getElementById('themeIcon');
            const body = document.body;

            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                body.classList.add('dark-mode');
                themeIcon.textContent = 'üåô';
            } else {
                themeIcon.textContent = '‚òÄÔ∏è';
            }

            themeToggleBtn.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                localStorage.setItem('theme', body.classList.contains('dark-mode') ? 'dark' : 'light');
                themeIcon.textContent = body.classList.contains('dark-mode') ? 'üåô' : '‚òÄÔ∏è';
            });

            // --- MOTIVATIONAL QUOTE ---
            const quotes = [
                "The only way to do great work is to love what you do. ‚Äì Steve Jobs",
                "Believe you can and you're halfway there. ‚Äì Theodore Roosevelt",
                "Your limitation‚Äîit's only your imagination."
            ];
            const quoteElement = document.getElementById('motivationalQuoteP');
            quoteElement.textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;

            const widgetsContainer = document.querySelector('.widgets-container');

            function selectElementContents(el) {
                if(!el) return;
                const range = document.createRange(); range.selectNodeContents(el);
                const sel = window.getSelection();
                if (sel) { sel.removeAllRanges(); sel.addRange(range); }
            }

            // --- TODO CARD & REMINDERS PERSISTENCE & RENDERING ---
            function saveData() {
                localStorage.setItem('todoCards', JSON.stringify(todoCardsData));
                localStorage.setItem('reminders', JSON.stringify(reminders));
                renderCalendarWidget();
            }

            function loadData() {
                const storedTodoCards = localStorage.getItem('todoCards');
                if (storedTodoCards) todoCardsData = JSON.parse(storedTodoCards);
                const storedReminders = localStorage.getItem('reminders');
                if (storedReminders) reminders = JSON.parse(storedReminders);

                renderTodoCards();
                renderReminders();
                renderCalendarWidget();
            }

            function renderTodoCards() {
                document.querySelectorAll('.todo-card').forEach(card => card.remove());
                todoCardsData.forEach(cardData => {
                    const cardElement = document.createElement('section');
                    cardElement.classList.add('widget', 'todo-card');
                    cardElement.id = cardData.id;
                    cardElement.innerHTML = `
                        <div class="widget-header">
                            <h2 class="card-title"><span class="card-title-text" contenteditable="true">${cardData.title}</span></h2>
                            <button class="close-btn close-card-btn" title="Close this list">√ó</button>
                        </div>
                        <ul class="task-list"></ul>
                        <button class="add-task-btn">+ Add New Task</button>
                        <div class="progress-item">
                            <div class="progress-bar-container"><div class="progress-bar"></div></div>
                            <p class="progress-label">0% Complete</p>
                        </div>`;

                    const calendarWidget = document.getElementById('calendarWidget');
                    widgetsContainer.insertBefore(cardElement, calendarWidget);

                    cardData.tasks.forEach(task => {
                        addTaskToTodoCard(cardElement, task.text, task.completed, task.dueDate, task.id);
                    });
                    updateProgressForCard(cardElement);

                    const cardTitleText = cardElement.querySelector('.card-title-text');
                    cardTitleText.addEventListener('keydown', e => {
                        if (e.key === 'Enter') { e.preventDefault(); cardTitleText.blur(); }
                    });
                    cardTitleText.addEventListener('blur', () => {
                        const cardDataToUpdate = todoCardsData.find(c => c.id === cardElement.id);
                        if(cardDataToUpdate) cardDataToUpdate.title = cardTitleText.textContent.trim();
                        saveData();
                    });
                });
            }

            function createTodoCard() {
                const newCardId = `todoCard-${Date.now()}`;
                const newCardData = {
                    id: newCardId,
                    title: `Untitled List ${todoCardsData.length + 1}`,
                    tasks: []
                };
                todoCardsData.push(newCardData);
                renderTodoCards();

                const newlyCreatedCardElement = document.getElementById(newCardId);
                if (newlyCreatedCardElement) {
                    const cardTitleText = newlyCreatedCardElement.querySelector('.card-title-text');
                    cardTitleText.focus();
                    selectElementContents(cardTitleText);
                    addTaskToTodoCard(newlyCreatedCardElement, "New Task", false, '');
                }
                saveData();
            }

            function addTaskToTodoCard(cardElement, taskText = "New Task", completed = false, dueDate = '', taskId = `task-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`) {
                const taskList = cardElement.querySelector('.task-list');
                const taskItem = document.createElement('li');
                taskItem.dataset.taskId = taskId;
                taskItem.innerHTML = `
                    <input type="checkbox" class="task-checkbox" ${completed ? 'checked' : ''}>
                    <div class="task-content">
                        <span class="task-label" contenteditable="true">${taskText}</span>
                        <input type="date" class="task-due-date-input" value="${dueDate}">
                    </div>
                    <button class="delete-task-btn" title="Delete Task">√ó</button>`;
                taskList.appendChild(taskItem);

                const cardData = todoCardsData.find(card => card.id === cardElement.id);
                if (!cardData.tasks.some(t => t.id === taskId)) {
                    cardData.tasks.push({ id: taskId, text: taskText, completed: completed, dueDate: dueDate });
                }

                taskItem.querySelector('.task-label').addEventListener('blur', (e) => {
                    const task = cardData.tasks.find(t => t.id === taskId);
                    if (task) task.text = e.target.textContent.trim();
                    saveData();
                });
                taskItem.querySelector('.task-due-date-input').addEventListener('change', (e) => {
                    const task = cardData.tasks.find(t => t.id === taskId);
                    if (task) task.dueDate = e.target.value;
                    saveData();
                    checkOverdueStatus(taskItem, task.completed, task.dueDate);
                });
                taskItem.querySelector('.task-checkbox').addEventListener('change', (e) => {
                    const task = cardData.tasks.find(t => t.id === taskId);
                    if (task) task.completed = e.target.checked;
                    if (e.target.checked) triggerConfetti();
                    saveData();
                    updateProgressForCard(cardElement);
                    checkOverdueStatus(taskItem, task.completed, task.dueDate);
                });
                taskItem.querySelector('.delete-task-btn').addEventListener('click', () => {
                    const index = cardData.tasks.findIndex(t => t.id === taskId);
                    if (index > -1) cardData.tasks.splice(index, 1);
                    taskItem.remove();
                    updateProgressForCard(cardElement);
                    saveData();
                });
                checkOverdueStatus(taskItem, completed, dueDate);
                updateProgressForCard(cardElement);
            }

            function checkOverdueStatus(taskItem, completed, dueDate) {
                const taskLabel = taskItem.querySelector('.task-label');
                if (completed || !dueDate) {
                    taskLabel.classList.remove('overdue');
                    return;
                }
                const now = new Date(); const due = new Date(dueDate);
                const nowNoTime = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const dueNoTime = new Date(due.getFullYear(), due.getMonth(), due.getDate());
                taskLabel.classList.toggle('overdue', dueNoTime < nowNoTime);
            }

            function updateProgressForCard(cardElement) {
                if(!cardElement) return;
                const checkboxes = cardElement.querySelectorAll('.task-list input[type="checkbox"]');
                const progressBar = cardElement.querySelector('.progress-bar');
                const progressLabel = cardElement.querySelector('.progress-label');
                if (!progressBar || !progressLabel) return;

                const totalTasks = checkboxes.length;
                let checkedTasks = 0;
                checkboxes.forEach(cb => {
                    const taskLabel = cb.closest('li').querySelector('.task-label');
                    if (cb.checked) {
                        checkedTasks++;
                        if (taskLabel) taskLabel.classList.add('completed');
                    } else {
                        if (taskLabel) taskLabel.classList.remove('completed');
                    }
                });
                const percentage = totalTasks === 0 ? 0 : Math.round((checkedTasks / totalTasks) * 100);
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${percentage}%`;
                progressLabel.textContent = `${checkedTasks} of ${totalTasks} tasks complete (${percentage}%)`;
                progressBar.classList.toggle('full', percentage === 100 && totalTasks > 0);
                progressBar.style.backgroundColor = (percentage === 100 && totalTasks > 0) ? 'var(--progress-bar-fill-complete)' : (percentage < 50 ? 'var(--progress-bar-fill-1)' : 'var(--progress-bar-fill-2)');
            }

            widgetsContainer.addEventListener('click', function(event) {
                if (event.target.classList.contains('add-task-btn')) {
                    addTaskToTodoCard(event.target.closest('.todo-card'));
                    saveData();
                }
                if (event.target.classList.contains('close-card-btn')) {
                    const cardElement = event.target.closest('.todo-card');
                    todoCardsData = todoCardsData.filter(card => card.id !== cardElement.id);
                    cardElement.remove();
                    saveData();
                }
            });
            document.getElementById('newPageBtn').addEventListener('click', createTodoCard);

            // --- REMINDERS WIDGET + MODAL LOGIC ---
            const remindersListEl = document.getElementById('remindersList');
            const newReminderInput = document.getElementById('newReminderInput');
            const addReminderBtn = document.getElementById('addReminderBtn');
            const reminderCalendarModal = document.getElementById('reminderCalendarModal');
            const calendarMonthYearEl = reminderCalendarModal.querySelector('#calendarMonthYear');
            const prevMonthBtn = reminderCalendarModal.querySelector('#prevMonthBtn');
            const nextMonthBtn = reminderCalendarModal.querySelector('#nextMonthBtn');
            const calendarGridEl = reminderCalendarModal.querySelector('#calendarGrid');
            const reminderTimeInput = reminderCalendarModal.querySelector('#reminderTimeInput');
            const setReminderBtn = reminderCalendarModal.querySelector('#setReminderBtn');
            const cancelReminderBtn = reminderCalendarModal.querySelector('#cancelReminderBtn');

            let modalCalendarDate = new Date();
            let selectedDate = null;
            let reminderTextToSet = '';

            function requestNotificationPermission() {
                if ("Notification" in window && Notification.permission === "default") {
                    Notification.requestPermission();
                }
            }

            function checkRemindersForNotification() {
                const now = new Date().getTime();
                const oneHour = 3600000;
                let needsSave = false;
                reminders.forEach(reminder => {
                    const dueDate = new Date(reminder.dueDate).getTime();
                    if (dueDate > now && (dueDate - now) <= oneHour && !reminder.completed && !reminder.notified) {
                        if (Notification.permission === "granted") new Notification("Upcoming Reminder!", { body: reminder.text });
                        reminder.notified = true;
                        needsSave = true;
                    }
                });
                if (needsSave) saveData();
            }

            function formatDueDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
                const dateToCompare = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                let datePart;
                if (dateToCompare.getTime() === today.getTime()) datePart = 'Today';
                else if (dateToCompare.getTime() === tomorrow.getTime()) datePart = 'Tomorrow';
                else datePart = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                const timePart = date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: true });
                return `${datePart} at ${timePart}`;
            }

            function renderReminders() {
                reminders.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                remindersListEl.innerHTML = '';
                if (reminders.length === 0) {
                    remindersListEl.innerHTML = '<li style="text-align: center; color: var(--text-light); border-bottom: none; padding: 10px 0;">No reminders yet. Add one below!</li>';
                    return;
                }
                reminders.forEach(reminder => {
                    const li = document.createElement('li');
                    li.dataset.id = reminder.id;
                    li.innerHTML = `
                        <input type="checkbox" class="reminder-checkbox" ${reminder.completed ? 'checked' : ''}>
                        <div class="reminder-details">
                            <div class="reminder-text ${reminder.completed ? 'completed' : ''}">${reminder.text}</div>
                            <div class="reminder-date">${formatDueDate(reminder.dueDate)}</div>
                        </div>
                        <button class="delete-reminder-btn" title="Delete Reminder">√ó</button>`;
                    li.querySelector('.reminder-checkbox').addEventListener('change', () => toggleReminderComplete(reminder.id));
                    li.querySelector('.delete-reminder-btn').addEventListener('click', () => deleteReminder(reminder.id));
                    remindersListEl.appendChild(li);
                });
            }

            function openCalendarModal() {
                reminderTextToSet = newReminderInput.value.trim();
                if (reminderTextToSet === '') {
                    alert("Please type a reminder message first!");
                    newReminderInput.focus();
                    return;
                }
                selectedDate = new Date();
                const now = new Date();
                reminderTimeInput.value = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                generateModalCalendar();
                reminderCalendarModal.style.display = 'flex';
            }

            function closeCalendarModal() { reminderCalendarModal.style.display = 'none'; }

            function generateModalCalendar() {
                calendarGridEl.innerHTML = '';
                const month = modalCalendarDate.getMonth();
                const year = modalCalendarDate.getFullYear();
                calendarMonthYearEl.textContent = `${modalCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayNames.forEach(day => {
                    const dayNameEl = document.createElement('div');
                    dayNameEl.classList.add('calendar-day-name');
                    dayNameEl.textContent = day;
                    calendarGridEl.appendChild(dayNameEl);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) calendarGridEl.appendChild(document.createElement('div'));

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('calendar-day');
                    dayEl.textContent = i;
                    const today = new Date();
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');
                    if (selectedDate && i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) dayEl.classList.add('selected');
                    dayEl.addEventListener('click', () => {
                        selectedDate = new Date(year, month, i);
                        generateModalCalendar();
                    });
                    calendarGridEl.appendChild(dayEl);
                }
            }

            prevMonthBtn.addEventListener('click', () => { modalCalendarDate.setMonth(modalCalendarDate.getMonth() - 1); generateModalCalendar(); });
            nextMonthBtn.addEventListener('click', () => { modalCalendarDate.setMonth(modalCalendarDate.getMonth() + 1); generateModalCalendar(); });

            function confirmAndSetReminder() {
                requestNotificationPermission();
                if (!selectedDate || !reminderTextToSet) return;
                const [hours, minutes] = reminderTimeInput.value.split(':');
                selectedDate.setHours(hours); selectedDate.setMinutes(minutes); selectedDate.setSeconds(0);
                reminders.push({
                    id: `rem-${Date.now()}`, text: reminderTextToSet,
                    completed: false, dueDate: selectedDate.toISOString(), notified: false
                });
                renderReminders();
                newReminderInput.value = '';
                closeCalendarModal();
                saveData();
            }

            setReminderBtn.addEventListener('click', confirmAndSetReminder);
            cancelReminderBtn.addEventListener('click', closeCalendarModal);

            function deleteReminder(reminderId) {
                reminders = reminders.filter(r => r.id !== reminderId);
                renderReminders();
                saveData();
            }
            function toggleReminderComplete(reminderId) {
                const reminder = reminders.find(r => r.id === reminderId);
                if (reminder) { reminder.completed = !reminder.completed; renderReminders(); saveData(); }
            }
            addReminderBtn.addEventListener('click', openCalendarModal);
            newReminderInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') openCalendarModal(); });

            // --- CALENDAR WIDGET LOGIC ---
            const calWidgetMonthYear = document.getElementById('calMonthYear');
            const calWidgetGrid = document.getElementById('widgetCalendarGrid');
            const calWidgetPrevBtn = document.getElementById('calPrevMonthBtn');
            const calWidgetNextBtn = document.getElementById('calNextMonthBtn');
            let widgetCalendarDate = new Date();

            function renderCalendarWidget() {
                if (!calWidgetGrid) return;
                calWidgetGrid.innerHTML = '';
                const month = widgetCalendarDate.getMonth();
                const year = widgetCalendarDate.getFullYear();
                calWidgetMonthYear.textContent = `${widgetCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayNames.forEach(day => {
                    const dayNameEl = document.createElement('div');
                    dayNameEl.classList.add('cal-day-name'); dayNameEl.textContent = day;
                    calWidgetGrid.appendChild(dayNameEl);
                });
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('cal-day', 'not-current-month');
                    dayEl.textContent = daysInPrevMonth - firstDayOfMonth + 1 + i;
                    calWidgetGrid.appendChild(dayEl);
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('cal-day'); dayEl.textContent = i;
                    const currentDateObj = new Date(year, month, i);
                    const today = new Date();
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');

                    const tasksForDay = [...reminders, ...todoCardsData.flatMap(card => card.tasks)]
                        .filter(task => {
                            if (!task.dueDate) return false;
                            const taskDate = new Date(task.dueDate);
                            return taskDate.getFullYear() === year && taskDate.getMonth() === month && taskDate.getDate() === i;
                        });

                    if (tasksForDay.length > 0) {
                        const totalTasks = tasksForDay.length;
                        const completedTasks = tasksForDay.filter(task => task.completed).length;
                        const dot = document.createElement('div');
                        dot.className = 'event-dot';
                        if (completedTasks === totalTasks) dot.classList.add('dot-green');
                        else if (completedTasks > 0) dot.classList.add('dot-yellow');
                        else dot.classList.add('dot-red');
                        dayEl.appendChild(dot);
                        dayEl.addEventListener('mouseenter', (e) => showTasksForDay(e, currentDateObj));
                        dayEl.addEventListener('mouseleave', hideTaskTooltip);
                    }

                    calWidgetGrid.appendChild(dayEl);
                }
            }
            calWidgetPrevBtn.addEventListener('click', () => { widgetCalendarDate.setMonth(widgetCalendarDate.getMonth() - 1); renderCalendarWidget(); });
            calWidgetNextBtn.addEventListener('click', () => { widgetCalendarDate.setMonth(widgetCalendarDate.getMonth() + 1); renderCalendarWidget(); });

            function showTasksForDay(event, date) {
                const oldTooltip = document.getElementById('calendar-tooltip');
                if (oldTooltip) oldTooltip.remove();
                const targetDate = new Date(date);
                const isSameDay = (d) => d.getFullYear() === targetDate.getFullYear() && d.getMonth() === targetDate.getMonth() && d.getDate() === targetDate.getDate();
                const dailyTasks = [...reminders, ...todoCardsData.flatMap(card => card.tasks)]
                    .filter(task => task.dueDate && isSameDay(new Date(task.dueDate)));
                if (dailyTasks.length === 0) return;

                const tooltip = document.createElement('div');
                tooltip.id = 'calendar-tooltip';
                tooltip.className = 'calendar-task-tooltip';
                const taskListHtml = dailyTasks.map(t => `<li class="${t.completed ? 'completed-task' : ''}">${t.text}</li>`).join('');
                tooltip.innerHTML = `<h4>Tasks for ${targetDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</h4><ul>${taskListHtml}</ul>`;
                document.body.appendChild(tooltip);
                tooltip.style.left = `${event.pageX + 15}px`;
                tooltip.style.top = `${event.pageY}px`;
                setTimeout(() => tooltip.classList.add('visible'), 10);
            }

            function hideTaskTooltip() {
                const existingTooltip = document.getElementById('calendar-tooltip');
                if (existingTooltip) {
                    existingTooltip.classList.remove('visible');
                    setTimeout(() => { if (existingTooltip.parentElement) existingTooltip.remove(); }, 200);
                }
            }

            // --- MOOD TRACKER LOGIC ---
            const moodEmojiTriggers = document.querySelectorAll('.mood-emoji-trigger');
            const moodLoggingModal = document.getElementById('moodLoggingModal');
            const modalSelectedMoodEmoji = document.getElementById('modalSelectedMoodEmoji');
            const moodNoteInput = document.getElementById('moodNoteInput');
            const saveMoodLogBtn = document.getElementById('saveMoodLogBtn');
            const cancelMoodLogBtn = document.getElementById('cancelMoodLogBtn');
            const viewMoodLogTabBtn = document.getElementById('viewMoodLogTabBtn');
            const fullMoodLogViewModal = document.getElementById('fullMoodLogViewModal');
            const closeFullLogViewBtn = document.getElementById('closeFullLogViewBtn');
            const fullLogListContainer = document.getElementById('fullLogListContainer');
            let currentSelectedMood = { type: '', emoji: '' };

            function openMoodModal(moodType, moodEmoji) {
                currentSelectedMood.type = moodType;
                currentSelectedMood.emoji = moodEmoji;
                modalSelectedMoodEmoji.textContent = moodEmoji;
                moodNoteInput.value = '';
                moodLoggingModal.classList.remove('fade-out');
                moodLoggingModal.style.display = 'flex';
                moodNoteInput.focus();
            }

            function closeMoodModal() {
                moodLoggingModal.classList.add('fade-out');
                setTimeout(() => { moodLoggingModal.style.display = 'none'; }, 400);
            }

            moodEmojiTriggers.forEach(trigger => {
                trigger.addEventListener('click', function() {
                    openMoodModal(this.dataset.mood, this.dataset.emoji);
                });
            });

            saveMoodLogBtn.addEventListener('click', () => {
                const note = moodNoteInput.value.trim();
                const timestamp = new Date();
                const moodEntry = {
                    mood: currentSelectedMood.type,
                    emoji: currentSelectedMood.emoji,
                    note: note,
                    timestamp: timestamp.toISOString()
                };
                saveMoodEntry(moodEntry);
                if (fullMoodLogViewModal.style.display === 'flex') renderFullMoodLog();
                closeMoodModal();
            });

            cancelMoodLogBtn.addEventListener('click', closeMoodModal);

            function getMoodLog() { return JSON.parse(localStorage.getItem('moodLog') || '[]'); }
            function saveMoodEntry(entry) {
                const log = getMoodLog();
                log.unshift(entry);
                localStorage.setItem('moodLog', JSON.stringify(log));
            }

            function renderFullMoodLog() {
                const log = getMoodLog();
                fullLogListContainer.innerHTML = '';
                if (log.length === 0) {
                    fullLogListContainer.innerHTML = '<p class="empty-full-log-message">Your mood log is empty. Start logging your mood using the emojis!</p>';
                    return;
                }
                log.forEach(entry => {
                    const li = document.createElement('li');
                    const entryDate = new Date(entry.timestamp);
                    const formattedTimestamp = entryDate.toLocaleString(undefined, { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    li.innerHTML = `
                        <span class="log-emoji">${entry.emoji}</span>
                        <div class="log-details">
                            <p class="log-note">${entry.note || '<em>No note added.</em>'}</p>
                            <p class="log-timestamp">Logged: ${formattedTimestamp}</p>
                        </div>`;
                    fullLogListContainer.appendChild(li);
                });
            }

            function closeFullLogViewModal() {
                fullMoodLogViewModal.classList.add('fade-out');
                setTimeout(() => { fullMoodLogViewModal.style.display = 'none'; }, 400);
            }

            viewMoodLogTabBtn.addEventListener('click', () => {
                renderFullMoodLog();
                fullMoodLogViewModal.classList.remove('fade-out');
                fullMoodLogViewModal.style.display = 'flex';
            });

            closeFullLogViewBtn.addEventListener('click', closeFullLogViewModal);

            // ===== HOROSCOPE MODAL LOGIC =====
            const getHoroscopeBtn = document.getElementById('getHoroscopeBtn');
            const horoscopeModal = document.getElementById('horoscopeModal');
            const closeHoroscopeBtn = document.getElementById('closeHoroscopeBtn');
            const horoscopeEmojiEl = document.getElementById('horoscopeEmoji');
            const horoscopeModalTextEl = document.getElementById('horoscopeModalText');

            const horoscopeData = [
                { emoji: "‚ôà", quote: "A burst of energy finds you today. Channel it into a project you're passionate about!" },
                { emoji: "‚ôâ", quote: "Patience is your ally. A slow and steady approach will lead to sweet success." },
                { emoji: "‚ôä", quote: "Your curiosity is your superpower. Ask questions and explore a new idea." },
                { emoji: "‚ôã", quote: "Listen to your heart. Your intuition is guiding you toward a comforting truth." },
                { emoji: "‚ôå", quote: "Don't be afraid to shine! Your natural charisma will open doors for you today." },
                { emoji: "‚ôç", quote: "A small act of organization will bring you great peace of mind. Tidy up your space or your schedule." },
                { emoji: "‚ôé", quote: "Seek balance in all things. A compromise will lead to a harmonious outcome." },
                { emoji: "‚ôè", quote: "A hidden truth may be revealed. Trust your instincts and look beneath the surface." },
                { emoji: "‚ôê", quote: "Adventure is calling! Even a small change in routine can feel like a grand journey." },
                { emoji: "‚ôë", quote: "Your discipline is admirable. A focused effort will bring you closer to a long-term goal." },
                { emoji: "‚ôí", quote: "Think outside the box. A unique solution is needed for an old problem." },
                { emoji: "‚ôì", quote: "Let your imagination wander. Creativity and dreams hold the key to your day." }
            ];

            function typeOutText(element, text) {
                element.textContent = '';
                let charIndex = 0;
                if (typingIntervalId) clearInterval(typingIntervalId);

                typingIntervalId = setInterval(() => {
                    if (charIndex < text.length) {
                        element.textContent += text.charAt(charIndex);
                        charIndex++;
                    } else {
                        clearInterval(typingIntervalId);
                        typingIntervalId = null;
                    }
                }, 40); // Typing speed
            }

            function openHoroscopeModal(emoji, text) {
                horoscopeEmojiEl.textContent = emoji;
                typeOutText(horoscopeModalTextEl, text);
                horoscopeModal.classList.remove('fade-out');
                horoscopeModal.style.display = 'flex';
            }

            function closeHoroscopeModal() {
                horoscopeModal.classList.add('fade-out');
                setTimeout(() => {
                    horoscopeModal.style.display = 'none';
                    if (typingIntervalId) {
                        clearInterval(typingIntervalId);
                        typingIntervalId = null;
                    }
                }, 400);
            }

            getHoroscopeBtn.addEventListener('click', () => {
                const TWENTY_FOUR_HOURS_IN_MS = 24 * 60 * 60 * 1000;
                const now = Date.now();
                const lastFetchTime = parseInt(localStorage.getItem('horoscopeFetchTime') || '0');

                if (!lastFetchTime || (now - lastFetchTime > TWENTY_FOUR_HOURS_IN_MS)) {
                    const newHoroscope = horoscopeData[Math.floor(Math.random() * horoscopeData.length)];
                    localStorage.setItem('dailyHoroscope', newHoroscope.quote);
                    localStorage.setItem('dailyEmoji', newHoroscope.emoji);
                    localStorage.setItem('horoscopeFetchTime', now.toString());
                    openHoroscopeModal(newHoroscope.emoji, newHoroscope.quote);
                } else {
                    const savedHoroscope = localStorage.getItem('dailyHoroscope');
                    const savedEmoji = localStorage.getItem('dailyEmoji');
                    openHoroscopeModal(savedEmoji, savedHoroscope);
                }
            });

            closeHoroscopeBtn.addEventListener('click', closeHoroscopeModal);

            // --- UNIVERSAL MODAL CLOSE ---
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                 modal.addEventListener('click', (event) => {
                     if (event.target === modal) {
                         if(modal.id === 'fullMoodLogViewModal') closeFullLogViewModal();
                         if(modal.id === 'moodLoggingModal') closeMoodModal();
                         if(modal.id === 'reminderCalendarModal') closeCalendarModal();
                         if(modal.id === 'horoscopeModal') closeHoroscopeModal();
                     }
                 });
             });

            // --- CONFETTI ---
            function triggerConfetti() {
                const confettiContainer = document.getElementById('confetti-container');
                if (!confettiContainer) return;
                for (let i = 0; i < 50; i++) {
                    const piece = document.createElement('div');
                    piece.classList.add('confetti-piece');
                    piece.style.left = `${Math.random() * 100}vw`;
                    const colors = ['#FFC107', '#4CAF50', '#2196F3', '#E91E63'];
                    piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    piece.style.animationDelay = `${Math.random() * 0.5}s`;
                    confettiContainer.appendChild(piece);
                    setTimeout(() => piece.remove(), 3500);
                }
            }

            // --- INITIALIZATION ---
            setInterval(checkRemindersForNotification, 60000);
            checkRemindersForNotification();
            loadData();
        });
    </script>
</body>
</html>
